---
title: "Introduction to rdeck"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Introduction to rdeck}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  out.width = "100%"
)

# disable token
options(rdeck.mapbox_access_token = "<no-token>")
```

`{rdeck}` lets you use R to describe interactive WebGL maps built with Uber's
[deck.gl](https://deck.gl) framework and [mapbox](https://www.mapbox.com/)
base maps.

These maps can smoothly render data interactively on a much larger scale than html/svg
frameworks like Leaflet. Visually appealing 3D and lighting effects are also possible, thanks
to WebGL rendering.

Some basic examples follow:

```{r setup}
library(rdeck)
library(dplyr)
library(sf)
library(viridis)
# loading deck.gl example data
library(RcppSimdJson)
```

# Non-MapboxGl basemap

```{r basemap}
# non-mapboxgl basemap
add_basemap <- function(rdeck, land_color = "#2f2f2f", water_color = "#242424") {
  countries <- "https://raw.githubusercontent.com/johan/world.geo.json/master/countries.geo.json"
  world <- st_bbox(c(xmin = -180, ymin = -90, xmax = 180, ymax = 90), crs = 4326) %>%
    st_as_sfc() %>%
    st_sf()

  rdeck %>%
    add_polygon_layer(
      name = "water",
      data = world,
      get_fill_color = {{ water_color }}
    ) %>%
    add_geojson_layer(
      name = "countries",
      data = countries,
      get_fill_color = {{ land_color }}
    )
}
```

# Scatterplot layer

```{r manhattan-data}
url <- "https://raw.githubusercontent.com/visgl/deck.gl-data/master/examples/scatterplot/manhattan.json"
manhattan_people <- fload(url) %>%
  as_tibble(.name_repair = ~ c("lon", "lat", "gender")) %>%
  mutate(position = sfc_point(lon, lat))

manhattan_people
```

```{r scatterplot-map}
rdeck(
  # disable basemap
  map_style = NULL,
  initial_bounds = st_bbox(manhattan_people$position),
  picking_radius = 2
) %>%
  add_basemap() %>%
  add_scatterplot_layer(
    name = "manhattan_people",
    data = manhattan_people,
    get_position = position,
    get_fill_color = scale_color_category(
      col = gender,
      palette = c("#3f51b5", "#e91e63"),
      # replace gender labels
      tick_format = function(ticks) c("male", "female")
    ),
    radius_scale = 30,
    radius_min_pixels = 0.25,
    # highlight dot density
    blending_mode = "additive",
    # interactivity
    pickable = TRUE,
    auto_highlight = TRUE,
    # per-gender highlight colour
    highlight_color = scale_color_category(
      col = gender,
      palette = c("#9fa8da", "#f48fb1"),
      legend = FALSE
    ),
    tooltip = gender
  )
```

## Group all points by gender

```{r manhattan-data-multipoint}
manhattan_people_multipoint <- manhattan_people %>%
  group_by(gender) %>%
  summarise(
    position = st_union(position),
    count = n(),
    .groups = "drop"
  )

manhattan_people_multipoint
```

```{r scatterplot-map-2}
rdeck(
  # disable basemap
  map_style = NULL,
  initial_bounds = st_bbox(manhattan_people_multipoint$position),
  picking_radius = 2
) %>%
  add_basemap() %>%
  add_scatterplot_layer(
    name = "manhattan_people_multipoint",
    data = manhattan_people_multipoint,
    get_position = position,
    get_fill_color = scale_color_category(
      col = gender,
      palette = c("#3f51b5", "#e91e63"),
      # replace gender labels
      tick_format = function(ticks) c("male", "female")
    ),
    radius_scale = 30,
    radius_min_pixels = 0.25,
    # highlight dot density
    blending_mode = "additive",
    # interactivity
    pickable = TRUE,
    auto_highlight = TRUE,
    # per-gender highlight colour
    highlight_color = scale_color_category(
      col = gender,
      palette = c("#9fa8da", "#f48fb1"),
      legend = FALSE
    ),
    tooltip = everything()
  )
```

## Scale radius by gender attribute

```{r scatterplot-map-3}
rdeck(
  # disable basemap
  map_style = NULL,
  initial_bounds = st_bbox(manhattan_people_multipoint$position),
  picking_radius = 2
) %>%
  add_basemap() %>%
  add_scatterplot_layer(
    name = "manhattan_people_multipoint",
    data = manhattan_people_multipoint,
    get_position = position,
    get_fill_color = scale_color_category(
      col = gender,
      palette = c("#3f51b5", "#e91e63"),
      # replace gender labels
      tick_format = function(ticks) c("male", "female")
    ),
    # radius = sqrt(gender) * radius_scale
    get_radius = scale_linear(
      col = gender,
      range = sqrt(1:2)
    ),
    radius_scale = 30,
    radius_min_pixels = 0.25,
    # highlight dot density
    blending_mode = "additive",
    # interactivity
    pickable = TRUE,
    auto_highlight = TRUE,
    # per-gender highlight colour
    highlight_color = scale_color_category(
      col = gender,
      palette = c("#9fa8da", "#f48fb1"),
      legend = FALSE
    ),
    tooltip = everything()
  )
```

## Create a _high-level_ layer abstraction

```{r manhattan-people-layer}
add_manhattan_people_layer <- function(rdeck, manhattan_data,
fill_palette, highlight_palette, get_radius) {
  rdeck %>%
    add_scatterplot_layer(
      name = "manhattan_people",
      data = manhattan_data,
      get_position = position,
      get_fill_color = scale_color_category(
        col = gender,
        palette = fill_palette,
        # replace gender labels
        tick_format = function(ticks) c("male", "female")
      ),
      # radius = sqrt(gender) * radius_scale
      get_radius = {{get_radius}},
      radius_scale = 30,
      radius_min_pixels = 0.25,
      # highlight dot density
      blending_mode = "additive",
      # interactivity
      pickable = TRUE,
      auto_highlight = TRUE,
      # per-gender highlight colour
      highlight_color = scale_color_category(
        col = gender,
        palette = highlight_palette,
        legend = FALSE
      ),
      tooltip = everything()
    )
}
```

```{r scatterplot-map-4}
rdeck(
  # disable basemap
  map_style = NULL,
  initial_bounds = st_bbox(manhattan_people_multipoint$position),
  picking_radius = 2
) %>%
  add_basemap() %>%
  add_manhattan_people_layer(
    manhattan_data = manhattan_people_multipoint,
    fill_palette = cividis(2, alpha = 0.7, direction = -1),
    highlight_palette = cividis(2, direction = -1),
    get_radius = scale_category(
      col = gender,
      levels = c(1, 2),
      range = c(1, sqrt(3))
    )
  )
```

# Heatmap layer

```{r heatmap}
url <- "https://raw.githubusercontent.com/visgl/deck.gl-data/master/examples/screen-grid/uber-pickup-locations.json"
uber_pickup_locations <- fload(url) %>%
  as_tibble(.name_repair = ~ c("lon", "lat", "weight")) %>%
  mutate(position = sfc_point(lon, lat))


manhattan <- st_bbox(
  c(xmin = -74.027975, ymin = 40.698608, xmax = -73.897478, ymax = 40.879367),
  crs = 4326
)

rdeck(
  # disable basemap
  map_style = NULL,
  initial_bounds = manhattan
) %>%
  add_basemap() %>%
  add_heatmap_layer(
    name = "uber_pickup_locations",
    data = uber_pickup_locations,
    get_position = position,
    get_weight = weight
  )
```
